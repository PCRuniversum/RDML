#' Gets fluorescence data vectors from \code{RDML} object
#' 
#' Gets fluorescence data vectors from \code{RDML} object with specified types, 
#' targets, dyes, sample names and method of experiment.
#' 
#' If \code{targets = NA}, then use all the available targets from run.\cr If 
#' \code{types = NA}, then use all the available types from specified 
#' \code{targets}.\cr \code{names} are really not samples names but names of 
#' fluorescence data vectors generated by \code{RDML$name.pattern} (see 
#' 'Details' at \link{RDML}).\cr Priority of \code{filter} options:
#' \code{react.ids} > \code{tubes} > \code{dyes} > \code{targets} > \code{types} >
#' \code{names}. In other words if you specified \code{targets} or
#' \code{types} you can't select samples with other type or target despite
#' specified \code{names}. \cr
#' 
#' @param filter list of filtering options (see 'Available Options')
#' @section Available Options: \describe{
#'    \item{method}{method of experiment: 'qPCR' or 'melt'}
#'    \item{react.ids}{\code{vector} of plate tube indices (i.e. 1, 2, 3)}
#'    \item{tubes}{\code{vector} of plate tube names (i.e. A1, A2, A3)}
#'    \item{dyes}{\code{vector} of dyes (i.e. FAM, VIC)}
#'    \item{targets}{\code{vector} of experiment targets to choose from}
#'    \item{types}{\code{vector} of experiment sample types to choose from}
#'    \item{names}{regular expression to select sample names}
#'    }
#' @return \code{data.frame} which contains selected fluorescence data 
#'   \code{vector}s and Cycles/Temperatures in the first column.
#' @section Warning: Resulting \code{data.frame} can contain columns with same 
#'   names! Use \code{name.pattern} at \code{RDML} object to avoid 
#'   this.
#' @author Konstantin A. Blagodatskikh <k.blag@@yandex.ru>, Stefan Roediger 
#'   <stefan.roediger@@hs-lausitz.de>, Michal Burdukiewicz 
#'   <michalburdukiewicz@@gmail.com>
#' @references Regular Expressions as used in R -- 
#'   http://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html
#' @keywords manip
#' @docType methods
#' @name GetFData
#' @aliases RDML.GetFData
#' @rdname getfdata-method
#' @include RDML.R
#' @examples 
#' ## EXAMPLE 1:
#' ## internal dataset BioRad_qPCR_melt.rdml (in 'data' directory)
#' ## generated by Bio-Rad CFX96. Contains qPCR and melting data.
#' ## Import without splitting by targets/types and with
#' ## custom name pattern.
#' library(chipPCR)
#' PATH <- path.package("RDML")
#' filename <- paste(PATH, "/extdata/", "BioRad_qPCR_melt.rdml", sep ="")
#' cfx96 <- RDML$new(filename, 
#'               name.pattern = "%TUBE%_%NAME%_%TYPE%_%TARGET%")
#' ## Select qPCR fluorescence data with names that contain word 'unkn'.
#' fdata <- cfx96$GetFData(filter = list(names="unkn"))
#' ## Show names of selected samples
#' names(fdata)
#' ## Use plotCurves function from the chipPCR package to 
#' ## get an overview of the amplification curves
#' plotCurves(fdata[, 1], fdata[, -1])
#' 
#' ## EXAMPLE 2:
#' ## internal dataset lc96_bACTXY.rdml (in 'data' directory)
#' ## generated by Roche LightCycler 96. Contains qPCR data
#' ## with four targets and two types.
#' ## Import with default settings.                     
#' PATH <- path.package("RDML")
#' filename <- paste(PATH, "/extdata/", "lc96_bACTXY.rdml", sep ="")
#' lc96 <- RDML$new(filename)
#' ## Select qPCR fluorescence data with targets 'FAM@@bACT' or 'Hex@@X',
#' ## type 'std' and names that contain word 'Sample 39' or 'Sample 4'
#' fdata <- lc96$GetFData(filter = list(targets=c("FAM@@bACT", "Hex@@X"), 
#'                                      types = "std",
#'                                      names="(Sample 39)|(Sample 4)"))
#' ## Show names of selected samples
#' names(fdata)
RDML$set("public", "GetFData",
         function(request,
                  data.type = "qPCR",
                  long.table = FALSE) {
           data.type <- {
             if(data.type == "qPCR" || data.type == "adp") {
               c(data.type = "adp",
                 first.col.name = "cyc")
             } else {
               c(data.type = "mdp",
                 first.col.name = "tmp")
             }
           }           
           
           fdata <- unlist(request[1,])
           out <- private$.experiment[[fdata["exp.id"]]]$
             run[[fdata["run.id"]]]$
             react[[fdata["react.id"]]]$
             data[[fdata["target"]]][[data.type["data.type"]]][, data.type["first.col.name"]]
           out <- cbind(out,
                        apply(request, 1,
                              function(fdata) {                         
                                dat <- private$.experiment[[fdata["exp.id"]]]$
                                  run[[fdata["run.id"]]]$
                                  react[[fdata["react.id"]]]$
                                  data[[fdata["target"]]][[data.type["data.type"]]][, "fluor"]
                                if(is.null(dat))
                                  return(rep(NA, length(out)))
                                dat
                              })
           )
           colnames(out)[1] <- data.type["first.col.name"]
           if(long.table) {
             out2 <- data.frame(
               fdata.name = rep(rownames(request), 
                                each= nrow(out)))
             for(col.id in names(request)) {
               out2 <- cbind(
                 out2,
                 rep(request[, col.id], each= nrow(out)) 
               )}             
             out2 <- cbind(out2, out[, data.type["first.col.name"]])
             out2 <- cbind(out2, c(out[, -1]))             
             colnames(out2) <- c("fdata.name",
                                 names(request),
                                 data.type["first.col.name"],
                                 "fluo")
             return(out2)               
           }
           out
         }
         , overwrite = TRUE)