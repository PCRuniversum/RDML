---
title: "Using RDML with other R packages"
author: "Konstantin A. Blagodatskikh, Micha&#322; Burdukiewicz, Stefan R&ouml;diger"
date: "`r Sys.Date()`"
output: 
rmarkdown::html_vignette:
toc: true
pandoc_args: [
"--number-sections"
]
bibliography: "RDML.bib"
---
```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>")
```

# Practical Example for the Usage of the **RMDL** package

A key benefit of the **RMDL** package is that it enables further statistical 
analysis of RDML data. This section provides some examples of **R** packages 
that link with the **RMDL** package. Moreover, it will give an example how 
other packages allow the manipulation of RDML objects.

In this example we will use the **qpcR** package [@ritz_qpcr_2008] to calculate 
the Cq values after the selction of an optimal sigmoidal model as suggested by 
the Akaike's An Information Criterion. The Cq value will be used to calculate 
the amplification efficiency from a calibration curve. The `effcalc` function 
from the **chipPCR** package [@roediger2015chippcr] will be used for this task.


## Preparation of the data

In section [xyz] it was shown how to read-in RDML data. In this section we will 
continoue with the built-in RDML example file `lc96_bACTXY.rdml`. This file was 
obtained during the measurement of human DNA concentration by a *LightCycler 
96* (Roche) and the *XY-Detect* kit (Syntol, Russia). The file is opened as 
described before:

```{r, results = "hide"}
library(RDML)
filename <- system.file("extdata/stepone_std.rdml", package = "RDML")
raw_data <- RDML$new(filename = filename)
```

For convenice we use the pipe function `%>%` from the **magrittr** package for 
further analysis. Next we fetch the amplification curve data from the RDML file.

```{r}
library(magrittr)
raw_data_tab <- raw_data$AsTable(
    # Custom name pattern 'position~sample~sample.type~target~run.id'
    name.pattern = paste(
        react$position,
        react$sample$id,
        private$.sample[[react$sample$id]]$type$value,
        data$tar$id,
        run$id$id, # run id added to names
        sep = "~"))
# Get all fluorescence data
fdata <- as.data.frame(raw_data$GetFData(raw_data_tab, long.table = FALSE))
```

```{r}
# Load the ggplot2 package
library(ggplot2)
library(reshape2)
fdata_gg <- melt(fdata, id.vars="cyc")
ggplot(data=fdata_gg, aes(x=cyc, y=value, color=variable)) + 
    geom_line() + labs(x="Cycle", y="RFU") + theme_light()
# 
```

During the next steps comes the **qpcR** package into use. The function 
`mselect` performs a sigmoidal model selection by different criteria (e.g., 
bias-corrected Akaike's Information Criterion). The function `efficiency` 
calculates the qPCR Cq values, amplification efficiency and other important 
qPCR parameters. In this example we set the parameter type of the `efficiency` 
funtion to `Cy0`. This will calculate the Cy0 value, which is the intersection 
of a tangent on the first derivative maximum with the abscissa as calculated 
according to @guescini_new_2008.

```{r, echo=FALSE, include=FALSE}
res_fit <- do.call(cbind, lapply(2L:ncol(fdata), function(block_column) {
    
    res_model <- try(mselect(pcrfit(data=fdata, cyc=1, fluo=block_column), do.all = TRUE), silent=TRUE)
    if(res_model %>% class == "try-error") {
        res_model <- NA
    }
    else{
        try(efficiency(res_model, plot=FALSE, type="Cy0"), silent=TRUE)
    }
        }
    )
)
colnames(res_fit) <- colnames(fdata)[-1]

Cq_SDM <- res_fit[rownames(res_fit) == "cpD2", ] %>% rbind %>% data.frame
colnames(Cq_SDM) <- c("Sample", "Cq")

dilution <- c(as.factor("ntc"), as.factor("unk"), 10000, 5000, 2500, 1250, 625)
matrix(unlist(Cq_SDM), nrow=length(dilution), ncol = 3)
```
The `effcalc` function was used to determine the coefficients of the calibration curve.

```{r, echo=FALSE, include=FALSE}
library(chipPCR)

```

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Calculated Cq
calculated_Cq <- 26.7

copy_number <- 1372
```
The Cq values from the unkown sample `unk` had an average Cq of `r calculated_Cq` which is a copy number of `r copy_number`.

(and, if not, is this ever a problem?)


# References
